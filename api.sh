#!/bin/bash
generate_random_string() {
    local length=$1
    local chars=${2:-"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-="}
    local random_string=""

    if [ -z "$length" ]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω–∞ –¥–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏."
        return 1
    fi

    for ((i = 0; i < length; i++)); do
        random_string+="${chars:RANDOM%${#chars}:1}"
    done
    echo "$random_string"
}

register_panel_user_interactive() {
    # 1. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ–º–µ–Ω –ø–∞–Ω–µ–ª–∏
    read -p "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω –≤–∞—à–µ–π –ø–∞–Ω–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, panel.example.com): " domain
    if [ -z "$domain" ]; then
        echo "‚ùå –û–®–ò–ë–ö–ê: –î–æ–º–µ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º."
        sleep 3
        return 1
    fi

    # 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å
    local username=$(generate_random_string 12)
    local password=$(generate_random_string 24)
    
    echo "üìù –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å–ª—É—á–∞–π–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ..."
    sleep 2
    
    # 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º API-–∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    local api_url="https://$domain/api/auth/register"
    local json_data="{\"username\": \"$username\", \"password\": \"$password\"}"
    
    local response=$(curl -s -X POST "$api_url" \
                     -H "Content-Type: application/json" \
                     -d "$json_data")

    # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
    local token=$(echo "$response" | jq -r '.response.token' 2>/dev/null)
    
    if [ -n "$token" ]; then
        echo "üéâ –£–°–ü–ï–•: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
        
        # 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ç–æ–∫–µ–Ω –≤ —Ñ–∞–π–ª .env –≤ –ø–∞–ø–∫–µ —Å–∫—Ä–∏–ø—Ç–∞
        local SCRIPT_DIR="/opt/Remnawave-autoinstall-script"
        local ENV_FILE="$SCRIPT_DIR/.env"
        
        echo -e "\n# Generated by script on $(date)" >> "$ENV_FILE"
        echo "ADMIN_USERNAME=$username" >> "$ENV_FILE"
        echo "ADMIN_PASSWORD=$password" >> "$ENV_FILE"
        echo "JWT_API_TOKENS_SECRET=$token" >> "$ENV_FILE"
        
        echo "‚úÖ –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ $ENV_FILE"
        
        # 6. –í—ã–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        echo "‚ùó‚ùó –í–ù–ò–ú–ê–ù–ò–ï: –°–û–•–†–ê–ù–ò–¢–ï –≠–¢–ò –î–ê–ù–ù–´–ï. –û–ù–ò –ù–ï –ë–£–î–£–¢ –ü–û–ö–ê–ó–ê–ù–´ –°–ù–û–í–ê."
        echo "üîë –õ–æ–≥–∏–Ω: $username"
        echo "üîë –ü–∞—Ä–æ–ª—å: $password"
        
        sleep 10
        return 0
    else
        echo "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."
        echo "‚ùó –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞: $response"
        sleep 5
        return 1
    fi
}
